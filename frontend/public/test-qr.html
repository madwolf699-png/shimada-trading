<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>QRコード読み取り</title>
    <style>
      video {
        width: 300px;
      }
      textarea {
        width: 300px;
        height: 100px;
      }
    </style>
  </head>
  <body>
    <h3>QRコード読み取り</h3>

    <video id="video" autoplay></video><br /><br />
    <textarea id="result" placeholder="ここにQRの内容が表示されます"></textarea>

    <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
    <script>
      const video = document.getElementById('video');
      const textarea = document.getElementById('result');

      navigator.mediaDevices
        .getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 },
          },
        })
        .then((stream) => {
          video.srcObject = stream;
        });

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      let scanned = false;

      video.addEventListener('loadedmetadata', () => {
        scan();
      });

      function scan() {
        if (scanned) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);

        if (code) {
          scanned = true;
          textarea.value = code.data;
          return;
        }
        requestAnimationFrame(scan);
      }
    </script>
  </body>
</html>
